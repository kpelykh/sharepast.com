<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                            http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
                            http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd">


    <bean id="rootNamespaceHandler" class="com.sharepast.resources.RootNamespaceRestlet"/>

    <!-- ================= private resource routing below ===================== -->

    <bean name="appResourceRouter" class="com.sharepast.security.AppSecureRouter">
        <property name="attachments">
            <map>
                <entry key="" value-ref="rootNamespaceHandler"/>

                <entry key="/home">
                    <bean class="com.sharepast.security.AppResourceFinder">
                        <lookup-method name="create" bean="homeResource"/>
                        <property name="name" value="#{homeResource.name}"/>
                    </bean>
                </entry>

                <entry key="/users/{userId}">
                    <bean class="com.sharepast.security.AppResourceFinder">
                        <lookup-method name="create" bean="userProfileResource"/>
                        <property name="name" value="#{userProfileResource.name}"/>
                        <property name="lock">
                            <bean class="com.sharepast.security.UriLock">
                                <property name="context" value="MY_USER"/>
                                <property name="actions">
                                    <list>
                                        <ref bean="ACTION_READ"/>
                                        <ref bean="ACTION_UPDATE"/>
                                        <ref bean="ACTION_CREATE"/>
                                        <ref bean="ACTION_DELETE"/>
                                    </list>
                                </property>
                            </bean>
                        </property>
                    </bean>
                </entry>

            </map>
        </property>
        <property name="routingMode">
            <util:constant static-field="org.restlet.routing.Router.MODE_BEST_MATCH"/>
        </property>
        <property name="defaultMatchingMode">
            <util:constant static-field="org.restlet.routing.Template.MODE_STARTS_WITH"/>
        </property>
        <property name="context" ref="appPlatform.childContext"/>
    </bean>


    <bean name="publicResourceRouter" class="org.restlet.ext.spring.SpringRouter">
        <property name="defaultAttachment" ref="directoryRestlet"/>
        <property name="attachments">
            <map>
                <entry key="/" value-ref="rootNamespaceHandler"/>

                <entry key="/users" value-ref="rootNamespaceHandler"/>

                <entry key="/users/new">
                    <bean class="com.sharepast.security.AppResourceFinder">
                        <lookup-method name="create" bean="newUserResource"/>
                    </bean>
                </entry>
            </map>
        </property>
        <property name="routingMode">
            <util:constant static-field="org.restlet.routing.Router.MODE_BEST_MATCH"/>
        </property>
        <property name="defaultMatchingMode">
            <util:constant static-field="org.restlet.routing.Template.MODE_EQUALS"/>
        </property>
        <property name="context" ref="appPlatform.childContext"/>
    </bean>


    <!-- static file access - css, js, etc. -->
    <bean id="directoryRestlet" class="org.restlet.resource.Directory">
        <constructor-arg index="0" ref="appPlatform.childContext"/>
        <constructor-arg index="1" value="file://#{path['web.resources']}/static"/>
        <property name="listingAllowed" value="false"/>
        <property name="deeplyAccessible" value="true"/>
        <property name="negotiatingContent" value="true"/>
        <property name="modifiable" value="false"/>
    </bean>

    <!-- create URI maps for resource lookup by name  -->

    <bean id="appAssembler" class="com.sharepast.restlet.spring.AppResourceRouteAssembler">
        <constructor-arg index="0" ref="appResourceRouter"/>
        <constructor-arg index="1" ref="publicResourceRouter"/>
    </bean>

</beans>