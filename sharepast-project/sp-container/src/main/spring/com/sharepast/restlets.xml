<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:util="http://www.springframework.org/schema/util"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                            http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
                            http://www.springframework.org/schema/context
                            http://www.springframework.org/schema/context/spring-context-3.0.xsd http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-2.0.xsd">


    <import resource="freemarker.xml"/>
    <import resource="dozerBeanMapping.xml"/>
    <import resource="resources.xml"/>

    <context:component-scan base-package="com.sharepast.restlet.services"/>
    <context:component-scan base-package="com.sharepast.resources"/>
    <context:component-scan base-package="com.sharepast.security"/>

    <!-- system Component bean -->
    <bean id="appPlatform" class="org.restlet.ext.spring.SpringComponent">
        <property name="name" value="RESTful App Server component"/>
        <property name="owner" value="Konstantin Pelykh"/>
        <property name="author" value="Konstantin Pelykh"/>
        <property name="defaultHost" ref="defaultHost"/>
        <property name="client">
            <util:constant static-field="org.restlet.data.Protocol.FILE"/>
        </property>
    </bean>

    <!-- system Context bean -->
    <bean id="appPlatform.context" name="context"
          class="org.springframework.beans.factory.config.PropertyPathFactoryBean"/>

    <bean id="defaultHost" class="org.restlet.ext.spring.SpringHost">
        <constructor-arg ref="appPlatform"/>
        <!--
        <property name="hostDomain"
        value="www.rmep.com|www.rmep.net|www.rmep.org" /> <property
        name="serverAddress" value="1.2.3.10|1.2.3.20" /> <property
        name="serverPort" value="80" />
        -->
        <property name="defaultAttachment" ref="application"/>
    </bean>

    <bean id="appPlatform.childContext" factory-bean="appPlatform.context" factory-method="createChildContext"/>

    <bean id="application" class="org.restlet.Application">
        <property name="name" value="RESTful Mail App application"/>
        <property name="description" value="Example application for 'Restlet in Action' book"/>
        <property name="owner" value="Konstantin Pelykh"/>
        <property name="author" value="Konstantin Pelykh"/>

        <property name="context" ref="appPlatform.childContext"/>
        <property name="inboundRoot" ref="restletRouter"/>
        <property name="statusService" ref="applicationStatusService"/>
    </bean>

    <bean id="restletRouter" class="org.restlet.ext.spring.SpringRouter">
        <property name="context" ref="appPlatform.childContext"/>
        <property name="defaultAttachment" ref="publicResourceRouter"/>
        <property name="attachments">
            <map>

                <!-- the only place where we render login page is ShiroAuthenticator -->
                <entry key="/login" value-ref="shiroAuthorizer"/>
                <entry key="/logout" value-ref="shiroAuthorizer"/>

                <!-- root handling resource -->
                <entry key="/">
                    <bean class="com.sharepast.security.AppResourceFinder">
                        <lookup-method name="create" bean="rootResource"/>
                        <property name="name" value="#{rootResource.name}"/>
                    </bean>
                </entry>


                <!-- all resources added to this path -->
                <entry key="${api.prefix}" value-ref="shiroAuthorizer"/>

            </map>
        </property>
        <property name="routingMode">
            <util:constant static-field="org.restlet.routing.Router.MODE_BEST_MATCH"/>
        </property>
        <property name="defaultMatchingMode">
            <util:constant static-field="org.restlet.routing.Template.MODE_EQUALS"/>
        </property>
    </bean>

    <bean id="shiroAuthorizer" class="com.sharepast.security.ShiroAuthenticator">
        <constructor-arg index="0" ref="appPlatform.childContext"/>
        <constructor-arg index="1" value="false"/>
        <constructor-arg index="2" value="sharepast.com"/>
        <property name="verifier" ref="shiroVerifier"/>
        <property name="next" ref="appResourceRouter"/>
        <property name="rechallenging" value="true"/>
        <property name="httpPort" value="${http.port}"/>
        <property name="httpsPort" value="${https.port}"/>

        <property name="interceptingLogin" value="true"/>
        <property name="interceptingLogout" value="true"/>
    </bean>

    <bean id="applicationStatusService" class="com.sharepast.restlet.services.ApplicationStatusService">
        <property name="defaultTemplateFactory">
            <bean class="com.sharepast.restlet.freemarker.FreemarkerRepresentationFactory">
                <property name="templateName" value="error/error.ftl"/>
            </bean>
        </property>
        <property name="statusTemplates">
            <map>
                <entry>
                    <key>
                        <util:constant static-field="org.restlet.data.Status.CLIENT_ERROR_UNAUTHORIZED"/>
                    </key>
                    <bean class="com.sharepast.restlet.freemarker.FreemarkerRepresentationFactory">
                        <property name="templateName" value="login.ftl"/>
                    </bean>
                </entry>
                <entry>
                    <key>
                        <util:constant static-field="org.restlet.data.Status.CLIENT_ERROR_FORBIDDEN"/>
                    </key>
                    <bean class="com.sharepast.restlet.freemarker.FreemarkerRepresentationFactory">
                        <property name="templateName" value="login.ftl"/>
                    </bean>
                </entry>

                <entry>
                    <key>
                        <util:constant static-field="org.restlet.data.Status.CLIENT_ERROR_NOT_FOUND"/>
                    </key>
                    <bean class="com.sharepast.restlet.freemarker.FreemarkerRepresentationFactory">
                        <property name="templateName" value="error/404.ftl"/>
                    </bean>
                </entry>
                <entry>
                    <key>
                        <util:constant static-field="org.restlet.data.Status.CLIENT_ERROR_GONE"/>
                    </key>
                    <bean class="com.sharepast.restlet.freemarker.FreemarkerRepresentationFactory">
                        <property name="templateName" value="error/410.ftl"/>
                    </bean>
                </entry>
                <entry>
                    <key>
                        <util:constant static-field="org.restlet.data.Status.SERVER_ERROR_NOT_IMPLEMENTED"/>
                    </key>
                    <bean class="com.sharepast.restlet.freemarker.FreemarkerRepresentationFactory">
                        <property name="templateName" value="error/501.ftl"/>
                    </bean>
                </entry>
                <entry>
                    <key>
                        <util:constant static-field="org.restlet.data.Status.SERVER_ERROR_INTERNAL"/>
                    </key>
                    <bean class="com.sharepast.restlet.freemarker.FreemarkerRepresentationFactory">
                        <property name="templateName" value="error/500.ftl"/>
                    </bean>
                </entry>
            </map>
        </property>
    </bean>

    <bean name="rootResource" class="com.sharepast.resources.RootResource" scope="prototype">
        <property name="representationTemplates">
            <map>
                <entry>
                    <key>
                        <util:constant static-field="org.restlet.data.MediaType.TEXT_HTML"/>
                    </key>
                    <bean class="com.sharepast.restlet.freemarker.FreemarkerRepresentationFactory">
                        <property name="templateName" value="root.ftl"/>
                    </bean>
                </entry>
            </map>
        </property>
    </bean>

    <bean id="logon" class="com.sharepast.security.LogonUtils">
        <constructor-arg index="0" value="${api.prefix}"/>
        <constructor-arg index="1" value="${public.api.prefix}"/>
        <property name="httpPort" value="${http.port}"/>
    </bean>

    <bean id="beanMapper" class="net.sf.dozer.util.mapping.DozerBeanMapper">
        <property name="mappingFiles">
            <list>
                <value>com/sharepast/dozerBeanMapping.xml</value>
            </list>
        </property>
    </bean>


</beans>